<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>F1 MANAGER 2025 — CORRIDA</title>

  <style>
    :root{
      --bg1:#05060a;
      --bg2:#0b1020;
      --panel:#0d1224cc;
      --stroke:#e9eaee;
      --stroke2:#bfc4cf;
      --muted:#9aa3b2;
      --card:#0f1630;
      --card2:#0a0f20;
      --chip:#121a34;
      --accent:#c11b2e;
      --radius:18px;
    }
    *{ box-sizing:border-box; margin:0; padding:0; }
    html,body{ height:100%; background: radial-gradient(1200px 600px at 20% 20%, #111a35 0%, var(--bg1) 45%, #000 100%); color:#fff; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; }
    body{ overflow:hidden; }

    .topbar{
      height:64px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:12px 14px;
      background: linear-gradient(180deg, rgba(8,10,18,.95) 0%, rgba(8,10,18,.65) 100%);
      border-bottom:1px solid rgba(255,255,255,.06);
      gap:12px;
    }
    .race-title{
      display:flex; align-items:center; gap:10px; min-width:240px;
    }
    .race-badge{
      width:34px; height:34px; border-radius:10px;
      background: rgba(255,255,255,.08);
      display:grid; place-items:center; overflow:hidden;
      border:1px solid rgba(255,255,255,.10);
    }
    .race-badge img{ width:100%; height:100%; object-fit:cover; display:block; }
    .race-meta{
      display:flex; flex-direction:column; line-height:1.05;
    }
    .race-meta b{ font-size:14px; }
    .race-meta span{ font-size:12px; color:var(--muted); margin-top:4px; }

    .controls{
      display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:flex-end;
    }
    .speed{
      display:flex; gap:8px; align-items:center;
      padding:6px 8px; border-radius:999px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.08);
    }
    .btn{
      border:0; cursor:pointer; color:#fff;
      padding:10px 14px;
      border-radius:999px;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.10);
      font-weight:700;
    }
    .btn.small{ padding:8px 12px; font-weight:800; }
    .btn.active{ background: rgba(193,27,46,.25); border-color: rgba(193,27,46,.6); }
    .btn.primary{ background:#f2f2f2; color:#111; border-color:#fff; }

    .grid{
      height: calc(100% - 64px);
      display:grid;
      grid-template-columns: 1.25fr 0.85fr;
      gap:14px;
      padding:14px;
    }

    .panel{
      background: linear-gradient(180deg, rgba(18,24,46,.55) 0%, rgba(10,12,20,.35) 100%);
      border:1px solid rgba(255,255,255,.08);
      border-radius: var(--radius);
      overflow:hidden;
      box-shadow: 0 12px 30px rgba(0,0,0,.35);
      min-height: 0;
    }

    .panel-head{
      padding:12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom:1px solid rgba(255,255,255,.07);
      background: rgba(0,0,0,.25);
    }
    .panel-head b{ font-size:13px; letter-spacing:.6px; text-transform:uppercase; }
    .panel-head span{ font-size:12px; color:var(--muted); }

    .track-wrap{
      height: 100%;
      display:flex;
      flex-direction:column;
      min-height:0;
    }
    .track-canvas{
      flex:1;
      min-height:0;
      padding:12px;
    }
    .track-frame{
      width:100%; height:100%;
      background: rgba(0,0,0,.35);
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.07);
      overflow:hidden;
      position:relative;
    }

    svg{ width:100%; height:100%; display:block; }
    .trackPathOuter{ stroke: rgba(0,0,0,.45); stroke-width: 16; fill:none; stroke-linecap:round; stroke-linejoin:round; }
    .trackPathInner{ stroke: var(--stroke); stroke-width: 10; fill:none; stroke-linecap:round; stroke-linejoin:round; }
    .trackPathInner2{ stroke: rgba(160,170,190,.9); stroke-width: 4; fill:none; stroke-linecap:round; stroke-linejoin:round; opacity:.7; }

    .carDot{ stroke: rgba(0,0,0,.55); stroke-width: 2; }
    .carFaceRing{ stroke: rgba(255,255,255,.25); stroke-width: 2; fill:none; }

    .right{
      display:flex;
      flex-direction:column;
      min-height:0;
    }
    .session{
      flex:1;
      min-height:0;
      overflow:auto;
      padding:10px;
    }
    .row{
      display:grid;
      grid-template-columns: 36px 1fr 64px;
      gap:10px;
      align-items:center;
      padding:10px 10px;
      border-radius: 14px;
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.07);
      margin-bottom:10px;
    }
    .pos{
      width:36px; height:36px;
      border-radius: 12px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      display:grid; place-items:center;
      font-weight:900;
    }
    .who{
      display:flex; flex-direction:column; gap:3px; min-width:0;
    }
    .who b{ font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .who span{ font-size:11px; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .gap{
      text-align:right;
      font-variant-numeric: tabular-nums;
      font-weight:800;
      color:#d7dbe7;
    }

    .mydrivers{
      border-top:1px solid rgba(255,255,255,.08);
      padding:12px;
      background: rgba(0,0,0,.18);
    }
    .cards{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    .card{
      background: rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.08);
      border-radius: 16px;
      padding:12px;
      position:relative;
      overflow:hidden;
    }
    .cardHead{
      display:flex; align-items:center; gap:10px;
      margin-bottom:10px;
    }
    .avatar{
      width:38px; height:38px;
      border-radius: 14px;
      background: rgba(255,255,255,.07);
      border:1px solid rgba(255,255,255,.10);
      overflow:hidden;
      flex:0 0 auto;
      display:grid; place-items:center;
      font-weight:900;
    }
    .avatar img{ width:100%; height:100%; object-fit:cover; display:block; }
    .cardHead .txt{ min-width:0; }
    .cardHead .txt b{ display:block; font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .cardHead .txt span{ display:block; font-size:11px; color:var(--muted); margin-top:2px; }

    .stats{
      display:flex; flex-wrap:wrap; gap:8px;
      color:#d7dbe7;
      font-size:12px;
      margin-bottom:10px;
    }
    .chip{
      padding:6px 10px;
      border-radius:999px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.08);
      font-weight:800;
    }
    .actions{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:8px;
      margin-top:8px;
    }
    .miniBtn{
      border:0; cursor:pointer;
      padding:10px 10px;
      border-radius:999px;
      background: rgba(255,255,255,.07);
      border:1px solid rgba(255,255,255,.10);
      color:#fff;
      font-weight:900;
      letter-spacing:.3px;
      text-transform:uppercase;
      font-size:12px;
    }
    .miniBtn.green{ background: rgba(37,161,92,.20); border-color: rgba(37,161,92,.55); }
    .miniBtn.red{ background: rgba(193,27,46,.20); border-color: rgba(193,27,46,.55); }
    select{
      width:100%;
      padding:9px 10px;
      border-radius: 999px;
      background: rgba(0,0,0,.25);
      color:#fff;
      border:1px solid rgba(255,255,255,.12);
      outline:none;
      font-weight:800;
    }

    /* Mobile */
    @media (max-width: 920px){
      body{ overflow:auto; }
      .grid{ grid-template-columns: 1fr; height:auto; }
      .panel{ min-height: 420px; }
      .right{ min-height: 520px; }
    }
  </style>
</head>

<body>
  <header class="topbar">
    <div class="race-title">
      <div class="race-badge"><img id="gpLogo" alt="" /></div>
      <div class="race-meta">
        <b id="gpName">GP</b>
        <span id="gpInfo">Volta — • Clima — • Pista —</span>
      </div>
    </div>

    <div class="controls">
      <div class="speed">
        <button class="btn small active" data-speed="1">1x</button>
        <button class="btn small" data-speed="2">2x</button>
        <button class="btn small" data-speed="4">4x</button>
      </div>
      <button class="btn primary" id="backBtn">VOLTAR AO LOBBY</button>
    </div>
  </header>

  <main class="grid">
    <section class="panel track-wrap">
      <div class="panel-head">
        <b>MAPA DA PISTA</b>
        <span id="trackHint">SVG • pathPoints • 60fps</span>
      </div>

      <div class="track-canvas">
        <div class="track-frame">
          <svg id="trackSvg" viewBox="0 0 1000 700" preserveAspectRatio="xMidYMid meet">
            <defs id="svgDefs"></defs>
            <path id="pathOuter" class="trackPathOuter"></path>
            <path id="pathInner" class="trackPathInner"></path>
            <path id="pathInner2" class="trackPathInner2"></path>

            <!-- carros -->
            <g id="carsLayer"></g>

            <!-- grid markers (opcional) -->
            <g id="miscLayer"></g>
          </svg>
        </div>
      </div>
    </section>

    <section class="panel right">
      <div class="panel-head">
        <b>SESSÃO</b>
        <span>TEMPO REAL</span>
      </div>

      <div class="session" id="sessionList"></div>

      <div class="mydrivers">
        <div class="panel-head" style="border:0;background:transparent;padding:0 0 10px 0;">
          <b>SEUS PILOTOS</b>
          <span></span>
        </div>

        <div class="cards" id="myCards"></div>
      </div>
    </section>
  </main>

  <script>
    /***********************
     * CONFIG / MAPEAMENTOS
     ***********************/
    const TEAM_COLORS = {
      mclaren: "#ff8000",
      ferrari: "#dc0000",
      mercedes: "#00d2be",
      redbull: "#1e41ff",
      rb: "#2b4562",
      williams: "#005aff",
      alpine: "#ff87bc",
      astonmartin: "#006f62",
      haas: "#b6babd",
      sauber: "#00ff87",
      audi: "#bfc4cf",
      "free agent": "#7b8496",
      default: "#9aa3b2"
    };

    // tenta manter compatível com ids diferentes
    function normTeamId(team){
      if(!team) return "default";
      const t = String(team).toLowerCase().trim();
      if(t.includes("mclaren")) return "mclaren";
      if(t.includes("ferrari")) return "ferrari";
      if(t.includes("mercedes")) return "mercedes";
      if(t.includes("red bull")) return "redbull";
      if(t === "rb" || t.includes("racing bulls")) return "rb";
      if(t.includes("williams")) return "williams";
      if(t.includes("alpine")) return "alpine";
      if(t.includes("aston")) return "astonmartin";
      if(t.includes("haas")) return "haas";
      if(t.includes("sauber")) return "sauber";
      if(t.includes("audi")) return "audi";
      if(t.includes("free")) return "free agent";
      return t.replace(/\s+/g,"");
    }

    function getTeamColor(team){
      const id = normTeamId(team);
      return TEAM_COLORS[id] || TEAM_COLORS.default;
    }

    // Ajuste aqui se seus caminhos forem diferentes
    function getDriverFace(driver){
      // driver.id recomendado: "lando_norris"
      const id = (driver && (driver.id || driver.slug || driver.code || driver.name)) ? String(driver.id || driver.slug || driver.code || driver.name) : "";
      const safe = id.toLowerCase().replace(/[^a-z0-9_]+/g,"_").replace(/^_+|_+$/g,"");
      // principais tentativas
      return [
        `assets/faces/${safe}.png`,
        `assets/drivers/${safe}.png`,
        `assets/faces/${safe}.jpg`,
        `assets/drivers/${safe}.jpg`,
      ];
    }

    function getTeamLogo(team){
      const id = normTeamId(team);
      return [
        `assets/teams/${id}.png`,
        `assets/logos/${id}.png`,
        `assets/teams/${id}.svg`,
      ];
    }

    /***********************
     * UTIL
     ***********************/
    function qs(name){
      const params = new URLSearchParams(location.search);
      return params.get(name) || "";
    }

    function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }

    function initials(name){
      const parts = String(name||"").trim().split(/\s+/).filter(Boolean);
      if(!parts.length) return "P";
      const a = parts[0][0] || "P";
      const b = (parts[1] ? parts[1][0] : "") || "";
      return (a + b).toUpperCase();
    }

    async function fetchFirstOk(urls){
      let lastErr = null;
      for(const u of urls){
        try{
          const r = await fetch(u, { cache: "no-store" });
          if(!r.ok) throw new Error(`${r.status} ${r.statusText}`);
          return { url:u, resp:r };
        }catch(e){ lastErr = e; }
      }
      throw lastErr || new Error("fetch failed");
    }

    async function preloadImage(urls){
      for(const u of urls){
        const ok = await new Promise(res=>{
          const img = new Image();
          img.onload = ()=>res(true);
          img.onerror = ()=>res(false);
          // evita cache ruim no GH Pages
          img.src = u + (u.includes("?") ? "&" : "?") + "v=" + Date.now();
        });
        if(ok) return u;
      }
      return null;
    }

    /***********************
     * ESTADO DA CORRIDA
     ***********************/
    const state = {
      speed: 1,
      lap: 1,
      lapsTotal: 5,
      weather: { label:"Chuva", trackTemp: 21 },
      track: {
        name: "australia",
        points: [],   // [{x,y}]
        bounds: null, // {minX,maxX,minY,maxY}
        pathD: ""
      },
      drivers: [], // grid (20)
      myDrivers: [], // 2
      t: 0
    };

    /***********************
     * DOM
     ***********************/
    const elGpLogo = document.getElementById("gpLogo");
    const elGpName = document.getElementById("gpName");
    const elGpInfo = document.getElementById("gpInfo");
    const elSessionList = document.getElementById("sessionList");
    const elMyCards = document.getElementById("myCards");

    const svg = document.getElementById("trackSvg");
    const defs = document.getElementById("svgDefs");
    const carsLayer = document.getElementById("carsLayer");
    const pathOuter = document.getElementById("pathOuter");
    const pathInner = document.getElementById("pathInner");
    const pathInner2 = document.getElementById("pathInner2");

    /***********************
     * TRACK LOADER (corrige o erro assets/tracks/australia.json)
     ***********************/
    async function loadTrack(trackKey){
      const key = (trackKey || "australia").toLowerCase();
      const base1 = `assets/tracks/${key}.json`;
      const base2 = `./assets/tracks/${key}.json`; // GH Pages às vezes precisa assim
      const urls = [
        base1,
        base1 + `?v=${Date.now()}`,
        base2,
        base2 + `?v=${Date.now()}`
      ];
      const { resp } = await fetchFirstOk(urls);
      const json = await resp.json();

      // Aceita formatos diferentes:
      // {pathPoints:[{x,y}]} OU {points:[[x,y],...]} OU {pathPoints:[[x,y],...]}
      let pts = json.pathPoints || json.points || [];
      pts = pts.map(p=>{
        if(Array.isArray(p)) return {x:Number(p[0]), y:Number(p[1])};
        return {x:Number(p.x), y:Number(p.y)};
      }).filter(p => Number.isFinite(p.x) && Number.isFinite(p.y));

      if(pts.length < 10) throw new Error("Track JSON sem pontos suficientes");

      // Normaliza para viewBox 1000x700
      const minX = Math.min(...pts.map(p=>p.x));
      const maxX = Math.max(...pts.map(p=>p.x));
      const minY = Math.min(...pts.map(p=>p.y));
      const maxY = Math.max(...pts.map(p=>p.y));

      const w = maxX - minX;
      const h = maxY - minY;
      const pad = 60;
      const targetW = 1000 - pad*2;
      const targetH = 700 - pad*2;

      const scale = Math.min(targetW / w, targetH / h);

      const norm = pts.map(p=>({
        x: (p.x - minX) * scale + pad,
        y: (p.y - minY) * scale + pad
      }));

      state.track.points = norm;
      state.track.bounds = {minX:pad, maxX:1000-pad, minY:pad, maxY:700-pad};

      // Path "D"
      const d = norm.map((p,i)=> (i===0 ? `M ${p.x.toFixed(2)} ${p.y.toFixed(2)}` : `L ${p.x.toFixed(2)} ${p.y.toFixed(2)}`)).join(" ");
      state.track.pathD = d + " Z";

      pathOuter.setAttribute("d", state.track.pathD);
      pathInner.setAttribute("d", state.track.pathD);
      pathInner2.setAttribute("d", state.track.pathD);
    }

    /***********************
     * GRID / DRIVERS
     * (Se você já salva grid do Q3 no localStorage, ele lê aqui)
     ***********************/
    function loadGrid(){
      // tenta pegar do Q3 (ajuste a chave se a sua for diferente)
      const keyCandidates = [
        "f1m_lastQ3Grid",
        "f1m_q3_grid",
        "f1m_grid",
        "raceGrid"
      ];
      let grid = null;
      for(const k of keyCandidates){
        try{
          const raw = localStorage.getItem(k);
          if(raw){
            const parsed = JSON.parse(raw);
            if(Array.isArray(parsed) && parsed.length >= 10){
              grid = parsed;
              break;
            }
          }
        }catch(_){}
      }

      // fallback (exemplo mínimo para não quebrar)
      if(!grid){
        grid = [
          {id:"lando_norris", name:"Lando Norris", team:"McLaren"},
          {id:"oscar_piastri", name:"Oscar Piastri", team:"McLaren"},
          {id:"charles_leclerc", name:"Charles Leclerc", team:"Ferrari"},
          {id:"carlos_sainz", name:"Carlos Sainz", team:"Ferrari"},
          {id:"lewis_hamilton", name:"Lewis Hamilton", team:"Mercedes"},
          {id:"george_russell", name:"George Russell", team:"Mercedes"},
          {id:"max_verstappen", name:"Max Verstappen", team:"Red Bull Racing"},
          {id:"sergio_perez", name:"Sergio Pérez", team:"Red Bull Racing"},
          {id:"fernando_alonso", name:"Fernando Alonso", team:"Aston Martin"},
          {id:"lance_stroll", name:"Lance Stroll", team:"Aston Martin"},
          {id:"pierre_gasly", name:"Pierre Gasly", team:"Alpine"},
          {id:"esteban_ocon", name:"Esteban Ocon", team:"Alpine"},
          {id:"alex_albon", name:"Alex Albon", team:"Williams"},
          {id:"logan_sargeant", name:"Logan Sargeant", team:"Williams"},
          {id:"kevin_magnussen", name:"Kevin Magnussen", team:"Haas"},
          {id:"nico_hulkenberg", name:"Nico Hülkenberg", team:"Haas"},
          {id:"yuki_tsunoda", name:"Yuki Tsunoda", team:"RB"},
          {id:"liam_lawson", name:"Liam Lawson", team:"RB"},
          {id:"guanyu_zhou", name:"Guanyu Zhou", team:"Sauber / Audi"},
          {id:"gabriel_bortoleto", name:"Gabriel Bortoleto", team:"Sauber / Audi"},
        ];
      }

      // garante 20
      state.drivers = grid.slice(0,20).map((d,i)=>({
        ...d,
        pos: i+1,
        lap: 0,
        progress: i * 0.02, // espalha no começo
        tire: "M",
        ers: 50,
        engineMode: "M2",
        aggression: "A2",
        pitRequest: false,
        color: getTeamColor(d.team),
        faceUrl: null,
        teamLogoUrl: null
      }));

      // “Seus pilotos” (tenta ler do userTeam)
      const userTeam = qs("userTeam") || qs("team") || "";
      const teamNorm = normTeamId(userTeam);

      const mine = state.drivers.filter(d => normTeamId(d.team) === teamNorm);
      state.myDrivers = (mine.length>=2 ? mine.slice(0,2) : state.drivers.slice(0,2));
    }

    /***********************
     * FACES/LOGOS: preload para parar o “piscando”
     ***********************/
    async function resolveFacesAndLogos(){
      // GP logo
      const userTeam = qs("userTeam") || "";
      const gpLogoTry = [
        `assets/ui/${(userTeam||"").toLowerCase()}_badge.png`,
        `assets/ui/gp_badge.png`,
        `assets/ui/f1_badge.png`
      ];
      const gpOk = await preloadImage(gpLogoTry);
      if(gpOk) elGpLogo.src = gpOk;

      for(const d of state.drivers){
        const face = await preloadImage(getDriverFace(d));
        d.faceUrl = face;

        const teamLogo = await preloadImage(getTeamLogo(d.team));
        d.teamLogoUrl = teamLogo;
      }
    }

    /***********************
     * SVG: cria patterns p/ faces e cria dots
     ***********************/
    function clearNode(n){ while(n.firstChild) n.removeChild(n.firstChild); }

    function buildSvgCars(){
      clearNode(defs);
      clearNode(carsLayer);

      for(const d of state.drivers){
        // pattern face
        const pid = `p_face_${d.id}`;
        if(d.faceUrl){
          const pat = document.createElementNS("http://www.w3.org/2000/svg","pattern");
          pat.setAttribute("id", pid);
          pat.setAttribute("patternUnits","objectBoundingBox");
          pat.setAttribute("width","1");
          pat.setAttribute("height","1");

          const img = document.createElementNS("http://www.w3.org/2000/svg","image");
          img.setAttributeNS("http://www.w3.org/1999/xlink","href", d.faceUrl + (d.faceUrl.includes("?")?"&":"?") + "v=" + Date.now());
          img.setAttribute("width","48");
          img.setAttribute("height","48");
          img.setAttribute("preserveAspectRatio","xMidYMid slice");

          // para o pattern funcionar bem:
          pat.setAttribute("viewBox","0 0 48 48");
          pat.appendChild(img);
          defs.appendChild(pat);
        }

        // dot
        const g = document.createElementNS("http://www.w3.org/2000/svg","g");
        g.setAttribute("data-driver", d.id);

        const dot = document.createElementNS("http://www.w3.org/2000/svg","circle");
        dot.setAttribute("r","7.2");
        dot.setAttribute("class","carDot");
        dot.setAttribute("fill", d.color);

        const face = document.createElementNS("http://www.w3.org/2000/svg","circle");
        face.setAttribute("r","6.0");
        face.setAttribute("class","carFaceRing");
        if(d.faceUrl){
          face.setAttribute("fill", `url(#p_face_${d.id})`);
        }else{
          face.setAttribute("fill", "rgba(0,0,0,.35)");
        }

        g.appendChild(dot);
        g.appendChild(face);
        carsLayer.appendChild(g);
      }
    }

    /***********************
     * UI: sessão + cards
     ***********************/
    function renderSession(){
      // ordena por posição (por enquanto)
      const list = [...state.drivers].sort((a,b)=>a.pos-b.pos);

      elSessionList.innerHTML = list.map(d=>{
        const team = normTeamId(d.team);
        const border = getTeamColor(team);
        const tag = (d.tire||"M");
        const title = `${d.name || "Piloto"}`;
        const teamName = String(d.team||"Equipe").toUpperCase();

        return `
          <div class="row" style="border-left:4px solid ${border};">
            <div class="pos">${d.pos}</div>
            <div class="who">
              <b>${escapeHtml(title)}</b>
              <span>${escapeHtml(teamName)} • Voltas: ${d.lap} • Pneu: ${tag}</span>
            </div>
            <div class="gap">${d.pos===1 ? "LEADER" : "+0.000"}</div>
          </div>
        `;
      }).join("");
    }

    function renderMyCards(){
      elMyCards.innerHTML = state.myDrivers.map(d=>{
        const ini = initials(d.name);
        const teamColor = getTeamColor(d.team);

        return `
          <div class="card" style="outline:2px solid rgba(0,0,0,0); box-shadow: inset 0 0 0 2px ${teamColor}55;">
            <div class="cardHead">
              <div class="avatar" style="box-shadow: inset 0 0 0 2px ${teamColor}66;">
                ${d.faceUrl ? `<img src="${d.faceUrl}?v=${Date.now()}" alt="">` : `<span>${ini}</span>`}
              </div>
              <div class="txt">
                <b>${escapeHtml(d.name || "Piloto")}</b>
                <span>${escapeHtml(String(d.team||"Equipe"))} • ${d.tire || "M"} • ${d.pitRequest ? "PIT" : "NORMAL"}</span>
              </div>
            </div>

            <div class="stats">
              <span class="chip">Carro: 100%</span>
              <span class="chip">Pneu: 100%</span>
              <span class="chip">ERS: ${d.ers}%</span>
              <span class="chip">Motor: ${d.engineMode}</span>
              <span class="chip">Agress: ${d.aggression}</span>
            </div>

            <div style="display:grid;grid-template-columns: 86px 1fr; gap:10px; align-items:center;">
              <button class="miniBtn red" data-act="pit" data-id="${d.id}">PIT</button>
              <select data-act="tire" data-id="${d.id}">
                <option value="S" ${d.tire==="S"?"selected":""}>S (Soft)</option>
                <option value="M" ${d.tire==="M"?"selected":""}>M (Medium)</option>
                <option value="H" ${d.tire==="H"?"selected":""}>H (Hard)</option>
                <option value="I" ${d.tire==="I"?"selected":""}>I (Inter)</option>
                <option value="W" ${d.tire==="W"?"selected":""}>W (Wet)</option>
              </select>
            </div>

            <div class="actions">
              <button class="miniBtn" data-act="eco" data-id="${d.id}">ECONOMIZAR</button>
              <button class="miniBtn green" data-act="atk" data-id="${d.id}">ATAQUE</button>
              <button class="miniBtn" data-act="motD" data-id="${d.id}">MOTOR -</button>
              <button class="miniBtn" data-act="motU" data-id="${d.id}">MOTOR +</button>
              <button class="miniBtn" data-act="agrD" data-id="${d.id}">AGRESS -</button>
              <button class="miniBtn" data-act="agrU" data-id="${d.id}">AGRESS +</button>
              <button class="miniBtn" data-act="ers" data-id="${d.id}" style="grid-column:1/-1;">ERS BOOST</button>
            </div>
          </div>
        `;
      }).join("");
    }

    function escapeHtml(s){
      return String(s||"")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    /***********************
     * SIMULAÇÃO (simples, mas estável)
     * Carros ficam sempre sobre a linha
     ***********************/
    function pointOnTrack(progress){
      const pts = state.track.points;
      const n = pts.length;
      const p = (progress % 1) * (n-1);
      const i = Math.floor(p);
      const t = p - i;
      const a = pts[i];
      const b = pts[Math.min(i+1, n-1)];
      return {
        x: a.x + (b.x - a.x)*t,
        y: a.y + (b.y - a.y)*t
      };
    }

    function tick(dt){
      const base = 0.02 * state.speed * dt; // velocidade base

      for(const d of state.drivers){
        // exemplo de “ritmo” por modo
        let pace = 1.0;
        if(d.pitRequest) pace *= 0.85;

        // (futuro) motor/agressividade influenciam
        if(d.engineMode === "M3") pace *= 1.06;
        if(d.engineMode === "M1") pace *= 0.95;

        if(d.aggression === "A3") pace *= 1.04;
        if(d.aggression === "A1") pace *= 0.97;

        d.progress += base * pace;

        // voltas
        if(d.progress >= 1){
          d.progress -= 1;
          d.lap += 1;
          if(d.lap >= state.lapsTotal){
            d.lap = state.lapsTotal;
          }
        }
      }

      // posição (ordena por (lap, progress))
      const sorted = [...state.drivers].sort((a,b)=>{
        const ka = a.lap + a.progress;
        const kb = b.lap + b.progress;
        return kb - ka;
      });
      sorted.forEach((d,idx)=> d.pos = idx+1);

      // atualiza dots no SVG
      for(const d of state.drivers){
        const g = carsLayer.querySelector(`g[data-driver="${CSS.escape(d.id)}"]`);
        if(!g) continue;
        const p = pointOnTrack(d.progress);
        g.setAttribute("transform", `translate(${p.x.toFixed(2)}, ${p.y.toFixed(2)})`);
      }

      renderSession();
    }

    /***********************
     * EVENTS
     ***********************/
    function bindUI(){
      document.querySelectorAll("[data-speed]").forEach(b=>{
        b.addEventListener("click", ()=>{
          document.querySelectorAll("[data-speed]").forEach(x=>x.classList.remove("active"));
          b.classList.add("active");
          state.speed = Number(b.getAttribute("data-speed")) || 1;
        });
      });

      document.getElementById("backBtn").addEventListener("click", ()=>{
        // ajuste para seu lobby real
        location.href = "index.html";
      });

      // delegação para botões dos cards
      elMyCards.addEventListener("click", (ev)=>{
        const btn = ev.target.closest("button[data-act]");
        if(!btn) return;
        const act = btn.getAttribute("data-act");
        const id = btn.getAttribute("data-id");
        const d = state.drivers.find(x=>x.id===id);
        if(!d) return;

        if(act==="pit"){
          d.pitRequest = !d.pitRequest;
          btn.classList.toggle("active", d.pitRequest);
          renderMyCards();
          return;
        }
        if(act==="eco"){
          d.aggression = "A1";
          d.engineMode = "M1";
          renderMyCards();
          return;
        }
        if(act==="atk"){
          d.aggression = "A3";
          d.engineMode = "M3";
          renderMyCards();
          return;
        }
        if(act==="motD"){
          d.engineMode = (d.engineMode==="M3") ? "M2" : (d.engineMode==="M2" ? "M1" : "M1");
          renderMyCards(); return;
        }
        if(act==="motU"){
          d.engineMode = (d.engineMode==="M1") ? "M2" : (d.engineMode==="M2" ? "M3" : "M3");
          renderMyCards(); return;
        }
        if(act==="agrD"){
          d.aggression = (d.aggression==="A3") ? "A2" : (d.aggression==="A2" ? "A1" : "A1");
          renderMyCards(); return;
        }
        if(act==="agrU"){
          d.aggression = (d.aggression==="A1") ? "A2" : (d.aggression==="A2" ? "A3" : "A3");
          renderMyCards(); return;
        }
        if(act==="ers"){
          d.ers = clamp(d.ers + 10, 0, 100);
          renderMyCards(); return;
        }
      });

      elMyCards.addEventListener("change", (ev)=>{
        const sel = ev.target.closest('select[data-act="tire"]');
        if(!sel) return;
        const id = sel.getAttribute("data-id");
        const d = state.drivers.find(x=>x.id===id);
        if(!d) return;
        d.tire = sel.value;
        renderSession();
        renderMyCards();
      });
    }

    /***********************
     * BOOT
     ***********************/
    (async function boot(){
      try{
        const trackKey = qs("track") || "australia";
        const gp = qs("gp") || "GP da Austrália 2025";

        elGpName.textContent = gp;
        state.track.name = trackKey;

        loadGrid();

        // clima simples (você pode ligar ao seu sistema depois)
        const rain = Math.random() < 0.35;
        state.weather = rain ? {label:"Chuva", trackTemp: 21} : {label:"Seco", trackTemp: 24};
        elGpInfo.textContent = `Volta ${state.lap} • Clima: ${state.weather.label} • Pista: ${state.weather.trackTemp}°C`;

        await loadTrack(trackKey);

        await resolveFacesAndLogos();
        buildSvgCars();

        renderSession();
        renderMyCards();
        bindUI();

        let last = performance.now();
        function loop(now){
          const dt = Math.min(0.05, (now - last) / 1000);
          last = now;
          tick(dt);
          requestAnimationFrame(loop);
        }
        requestAnimationFrame(loop);

      }catch(err){
        alert("Erro na corrida: Falha ao carregar: " + (err && err.message ? err.message : String(err)));
        console.error(err);
      }
    })();
  </script>
</body>
</html>
