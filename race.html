<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>F1 MANAGER 2025 – CORRIDA</title>
  <style>
    :root{
      --bg0:#05070d;
      --bg1:#0b1022;
      --card:#131a2f;
      --card2:#0f152a;
      --line:rgba(255,255,255,.08);
      --text:#e8ecff;
      --muted:rgba(232,236,255,.72);
      --muted2:rgba(232,236,255,.55);
      --good:#32d583;
      --warn:#ffb020;
      --bad:#ff3b30;
      --chip:rgba(255,255,255,.08);
      --shadow: 0 16px 50px rgba(0,0,0,.45);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 20% 0%, rgba(80,120,255,.18), transparent 55%),
        radial-gradient(900px 700px at 80% 10%, rgba(255,80,120,.12), transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg0));
      overflow:hidden;
    }

    /* ===== TOP BAR ===== */
    .topbar{
      position:sticky; top:0; z-index:50;
      padding:14px 14px 10px;
      display:flex; gap:12px; align-items:center; justify-content:space-between;
    }
    .race-pill{
      display:flex; align-items:center; gap:10px;
      padding:10px 12px;
      border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border-radius:16px;
      box-shadow: var(--shadow);
      min-width:260px;
    }
    .team-logo{
      width:28px; height:28px; border-radius:8px;
      background:rgba(255,255,255,.06);
      border:1px solid var(--line);
      display:grid; place-items:center;
      overflow:hidden;
      flex:0 0 auto;
    }
    .team-logo img{width:100%; height:100%; object-fit:contain}
    .race-title{display:flex; flex-direction:column; line-height:1.1}
    .race-title .gp{font-weight:800; letter-spacing:.2px; font-size:14px}
    .race-title .meta{font-size:12px; color:var(--muted2); margin-top:3px}

    .controls{
      display:flex; align-items:center; gap:10px;
    }
    .speed{
      display:flex; gap:8px; align-items:center;
      padding:8px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      border-radius:999px;
      box-shadow: var(--shadow);
    }
    .chip{
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      color:var(--text);
      padding:7px 12px;
      border-radius:999px;
      font-weight:700;
      font-size:12px;
      cursor:pointer;
      user-select:none;
    }
    .chip.active{
      background:rgba(255,0,60,.18);
      border-color:rgba(255,0,60,.35);
      box-shadow:0 0 0 2px rgba(255,0,60,.10) inset;
    }
    .btn{
      border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04));
      color:var(--text);
      padding:10px 14px;
      border-radius:999px;
      font-weight:900;
      cursor:pointer;
      box-shadow: var(--shadow);
      text-decoration:none;
      display:inline-flex; align-items:center; gap:10px;
    }
    .btn:active{transform:translateY(1px)}

    /* ===== LAYOUT ===== */
    .shell{
      height:calc(100% - 64px);
      padding:10px 14px 14px;
      display:grid;
      grid-template-columns: minmax(340px, 1.15fr) minmax(320px, .85fr);
      gap:12px;
    }

    .panel{
      border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border-radius:18px;
      box-shadow: var(--shadow);
      overflow:hidden;
      min-height:0;
    }

    .panel-head{
      padding:12px 14px;
      display:flex; align-items:center; justify-content:space-between;
      border-bottom:1px solid var(--line);
      background:rgba(0,0,0,.12);
    }
    .panel-head .title{
      font-weight:900; letter-spacing:.25px; font-size:12px;
      text-transform:uppercase;
      color:rgba(255,255,255,.92);
    }
    .panel-head .sub{
      font-size:12px; color:var(--muted2);
    }

    /* ===== MAP ===== */
    .map-wrap{
      position:relative;
      height:100%;
      min-height:0;
      display:flex;
      flex-direction:column;
    }
    #trackStage{
      position:relative;
      flex:1;
      min-height:0;
      padding:10px;
    }
    #trackViewport{
      width:100%;
      height:100%;
      border-radius:14px;
      background:#000;
      border:1px solid rgba(255,255,255,.06);
      overflow:hidden;
      display:grid;
      place-items:center;
      position:relative;
    }

    /* SVG injected */
    #trackViewport svg{
      width:100%;
      height:100%;
      display:block;
    }

    /* Car dots layer */
    #carsLayer{
      position:absolute;
      inset:0;
      pointer-events:none;
    }
    .carDot{
      position:absolute;
      width:10px; height:10px;
      border-radius:999px;
      transform:translate(-50%,-50%);
      box-shadow:
        0 0 0 2px rgba(0,0,0,.65),
        0 0 18px rgba(255,255,255,.18);
      opacity:.95;
    }
    .carDot::after{
      content:"";
      position:absolute;
      inset:-4px;
      border-radius:999px;
      background:radial-gradient(circle, rgba(255,255,255,.30), transparent 55%);
      opacity:.35;
    }

    /* start/finish marker */
    .sf{
      position:absolute;
      width:18px; height:10px;
      border-radius:4px;
      background:
        linear-gradient(90deg, #fff 0 25%, #000 25% 50%, #fff 50% 75%, #000 75% 100%);
      border:1px solid rgba(255,255,255,.28);
      transform:translate(-50%,-50%) rotate(0deg);
      opacity:.95;
      box-shadow:0 8px 20px rgba(0,0,0,.35);
      pointer-events:none;
    }

    /* ===== RIGHT SIDE ===== */
    .right{
      display:grid;
      grid-template-rows: 1fr auto;
      gap:12px;
      min-height:0;
    }

    .session{
      min-height:0;
      display:flex; flex-direction:column;
    }

    .session-list{
      padding:10px;
      overflow:auto;
      min-height:0;
    }
    .row{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      padding:10px 10px;
      border:1px solid var(--line);
      border-radius:14px;
      background:rgba(255,255,255,.03);
      margin-bottom:10px;
    }
    .row-left{display:flex; align-items:center; gap:10px; min-width:0}
    .pos{
      width:28px; height:28px;
      border-radius:10px;
      display:grid; place-items:center;
      font-weight:900;
      background:rgba(255,255,255,.06);
      border:1px solid var(--line);
      flex:0 0 auto;
    }
    .badge{
      width:28px; height:28px;
      border-radius:10px;
      display:grid; place-items:center;
      font-weight:900;
      background:rgba(255,255,255,.06);
      border:1px solid var(--line);
      overflow:hidden;
      flex:0 0 auto;
    }
    .badge img{width:100%; height:100%; object-fit:cover; display:block}
    .who{
      display:flex; flex-direction:column; min-width:0;
    }
    .who .name{
      font-weight:900; font-size:13px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .who .team{
      font-size:11px; color:var(--muted2);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      margin-top:2px;
    }
    .row-right{
      display:flex; flex-direction:column; align-items:flex-end; gap:3px;
      flex:0 0 auto;
    }
    .gap{font-weight:900; font-size:12px}
    .tiny{font-size:11px; color:var(--muted2)}

    /* ===== MY DRIVERS ===== */
    .myDrivers{
      padding:10px;
      min-height:0;
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
    }
    .card{
      border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border-radius:18px;
      padding:10px;
      box-shadow: var(--shadow);
      min-width:0;
    }
    .cardTop{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-bottom:8px;
    }
    .driverMini{
      display:flex; align-items:center; gap:10px; min-width:0;
    }
    .face{
      width:34px; height:34px;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      overflow:hidden;
      flex:0 0 auto;
    }
    .face img{width:100%; height:100%; object-fit:cover; display:block}
    .dn{
      display:flex; flex-direction:column; min-width:0;
      line-height:1.1;
    }
    .dn .n{font-weight:950; font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .dn .t{font-size:11px; color:var(--muted2); margin-top:2px}

    .pill{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      font-weight:900;
      font-size:11px;
      flex:0 0 auto;
      display:inline-flex; align-items:center; gap:8px;
    }

    .stats{
      display:flex; flex-wrap:wrap; gap:8px;
      font-size:11px; color:var(--muted);
      margin-bottom:8px;
    }
    .stats span{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      white-space:nowrap;
    }

    .actions{
      display:grid;
      grid-template-columns: 62px 1fr;
      gap:8px;
      align-items:center;
      margin-bottom:8px;
    }
    .pitBtn{
      border:1px solid rgba(255,0,60,.35);
      background:rgba(255,0,60,.15);
      color:#fff;
      font-weight:950;
      border-radius:999px;
      padding:10px 0;
      cursor:pointer;
      text-align:center;
      user-select:none;
    }
    .pitBtn.off{
      border-color: var(--line);
      background:rgba(255,255,255,.06);
      color:rgba(255,255,255,.9);
    }
    .sel{
      width:100%;
      border-radius:999px;
      padding:10px 12px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.25);
      color:var(--text);
      font-weight:800;
      outline:none;
    }

    .gridBtns{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:8px;
    }
    .gbtn{
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      color:var(--text);
      font-weight:950;
      border-radius:999px;
      padding:10px 10px;
      cursor:pointer;
      text-align:center;
      user-select:none;
      font-size:11px;
    }
    .gbtn.good{
      border-color:rgba(50,213,131,.35);
      background:rgba(50,213,131,.15);
    }
    .gbtn:active{transform:translateY(1px)}
    .bigbtn{
      grid-column:1 / -1;
      border:1px solid var(--line);
      background:rgba(255,255,255,.05);
      border-radius:999px;
      padding:10px 10px;
      font-weight:950;
      cursor:pointer;
      text-align:center;
      user-select:none;
      font-size:11px;
    }

    /* ===== RESPONSIVE ===== */
    @media (max-width: 980px){
      body{overflow:auto}
      .shell{
        height:auto;
        grid-template-columns:1fr;
      }
      .right{
        grid-template-rows:auto auto;
      }
      #trackStage{height:520px}
    }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="race-pill">
      <div class="team-logo" id="topTeamLogo">
        <img id="topTeamLogoImg" alt="" style="display:none">
      </div>
      <div class="race-title">
        <div class="gp" id="gpTitle">GP</div>
        <div class="meta" id="gpMeta">Volta 1 • Clima: — • Pista: —</div>
      </div>
    </div>

    <div class="controls">
      <div class="speed">
        <div class="chip active" data-speed="1">1x</div>
        <div class="chip" data-speed="2">2x</div>
        <div class="chip" data-speed="4">4x</div>
      </div>
      <a class="btn" id="backBtn" href="index.html">VOLTAR AO LOBBY</a>
    </div>
  </div>

  <div class="shell">
    <!-- LEFT: MAP -->
    <div class="panel map-wrap">
      <div class="panel-head">
        <div class="title">Mapa da pista</div>
        <div class="sub" id="mapSub">SVG • pathPoints • 60fps</div>
      </div>

      <div id="trackStage">
        <div id="trackViewport">
          <!-- SVG injected here -->
          <div id="carsLayer"></div>
          <div class="sf" id="sfMarker" style="display:none"></div>
        </div>
      </div>
    </div>

    <!-- RIGHT -->
    <div class="right">
      <!-- SESSION LIST -->
      <div class="panel session">
        <div class="panel-head">
          <div class="title">Sessão</div>
          <div class="sub">Tempo real</div>
        </div>
        <div class="session-list" id="sessionList"></div>
      </div>

      <!-- MY DRIVERS -->
      <div class="panel">
        <div class="panel-head">
          <div class="title">Seus pilotos</div>
          <div class="sub" id="mySub">Controles</div>
        </div>
        <div class="myDrivers" id="myDrivers"></div>
      </div>
    </div>
  </div>

  <script>
    /***************
     * UTIL
     ***************/
    const $ = (s, el=document) => el.querySelector(s);
    const $$ = (s, el=document) => Array.from(el.querySelectorAll(s));

    function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }
    function safeText(s){ return (s ?? "").toString(); }

    function initials(name){
      const parts = safeText(name).trim().split(/\s+/).filter(Boolean);
      if(!parts.length) return "??";
      const a = parts[0][0] || "?";
      const b = (parts.length>1 ? parts[parts.length-1][0] : (parts[0][1]||"")) || "";
      return (a+b).toUpperCase();
    }

    /***************
     * CONFIG TEAMS
     * (cores e paths; se algum logo/face não existir, cai no fallback)
     ***************/
    const TEAM_COLORS = {
      ferrari: "#DC0000",
      mclaren: "#FF8700",
      mercedes: "#00D2BE",
      redbull: "#1E41FF",
      rb: "#2B4562",
      williams: "#005AFF",
      astonmartin: "#006F62",
      alpine: "#FF87BC",
      haas: "#B6BABD",
      sauber: "#00FF87"
    };

    const TEAM_LOGO_PATH = (teamId) => `/assets/logos/${teamId}.png`;  // se não existir, não quebra
    const FACE_PATH = (driverId) => `/assets/faces/${driverId}.png`;    // se não existir, cai no fallback

    /***************
     * URL PARAMS
     ***************/
    const qs = new URLSearchParams(location.search);
    const trackName = qs.get("track") || "australia";
    const gpName = qs.get("gp") || "GP";
    const userTeam = (qs.get("userTeam") || "mclaren").toLowerCase();

    // volta total / estado
    let totalLaps = parseInt(qs.get("laps") || "5", 10);
    if (!Number.isFinite(totalLaps) || totalLaps < 1) totalLaps = 5;

    /***************
     * DEFAULT GRID (fallback)
     * Se você já tem grid salvo do Q3, ele vai ser carregado do localStorage
     ***************/
    const DEFAULT_GRID = [
      { id:"norris", name:"Lando Norris", team:"mclaren" },
      { id:"piastri", name:"Oscar Piastri", team:"mclaren" },
      { id:"leclerc", name:"Charles Leclerc", team:"ferrari" },
      { id:"sainz", name:"Carlos Sainz", team:"ferrari" },
      { id:"hamilton", name:"Lewis Hamilton", team:"mercedes" },
      { id:"russell", name:"George Russell", team:"mercedes" },
      { id:"verstappen", name:"Max Verstappen", team:"redbull" },
      { id:"perez", name:"Sergio Pérez", team:"redbull" },
      { id:"alonso", name:"Fernando Alonso", team:"astonmartin" },
      { id:"stroll", name:"Lance Stroll", team:"astonmartin" },
      { id:"gasly", name:"Pierre Gasly", team:"alpine" },
      { id:"ocon", name:"Esteban Ocon", team:"alpine" },
      { id:"hulkenberg", name:"Nico Hülkenberg", team:"haas" },
      { id:"magnussen", name:"Kevin Magnussen", team:"haas" },
      { id:"albon", name:"Alex Albon", team:"williams" },
      { id:"sargeant", name:"Logan Sargeant", team:"williams" },
      { id:"tsunoda", name:"Yuki Tsunoda", team:"rb" },
      { id:"lawson", name:"Liam Lawson", team:"rb" },
      { id:"zhou", name:"Guanyu Zhou", team:"sauber" },
      { id:"bortoleto", name:"Gabriel Bortoleto", team:"sauber" }
    ];

    function loadGridFromStorage(){
      // tenta nomes comuns de state; se não existir, cai no DEFAULT_GRID
      const keys = [
        "f1m_q3_grid",
        "f1m_grid_q3",
        "f1m_grid",
        "career_grid_q3",
        "career_grid",
        "race_grid"
      ];
      for (const k of keys){
        try{
          const raw = localStorage.getItem(k);
          if(!raw) continue;
          const parsed = JSON.parse(raw);
          if(Array.isArray(parsed) && parsed.length >= 10){
            // normaliza
            return parsed.map((d, idx) => ({
              id: (d.id || d.driverId || d.code || ("drv"+idx)).toString().toLowerCase(),
              name: d.name || d.driverName || d.fullName || ("Piloto " + (idx+1)),
              team: (d.team || d.teamId || d.constructor || "team").toString().toLowerCase()
            }));
          }
        }catch(e){}
      }
      return DEFAULT_GRID.slice();
    }

    let GRID = loadGridFromStorage();

    /***************
     * HEADER / LINKS
     ***************/
    $("#gpTitle").textContent = safeText(gpName);
    $("#backBtn").href = qs.get("back") || "index.html";

    // top logo
    (function setTopLogo(){
      const img = $("#topTeamLogoImg");
      img.src = TEAM_LOGO_PATH(userTeam);
      img.onload = () => { img.style.display = "block"; };
      img.onerror = () => { img.style.display = "none"; };
    })();

    /***************
     * WEATHER (simples, mas estável)
     ***************/
    const WEATHER_PRESETS = [
      { label:"Seco", temp: 26 },
      { label:"Nublado", temp: 23 },
      { label:"Chuva", temp: 21 }
    ];
    // determinístico por pista (não fica mudando toda hora)
    const seed = (trackName.split("").reduce((a,c)=>a+c.charCodeAt(0),0) + totalLaps) % WEATHER_PRESETS.length;
    let weather = WEATHER_PRESETS[seed];

    /***************
     * TRACK: LOAD SVG (sem JSON)
     * Corrige o erro 404 assets/tracks/australia.json
     ***************/
    async function loadTrackSVG(trackName){
      const response = await fetch(`/assets/tracks/${trackName}.svg`, { cache: "no-store" });
      if(!response.ok){
        throw new Error(`Falha ao carregar: assets/tracks/${trackName}.svg`);
      }
      const svgText = await response.text();
      const parser = new DOMParser();
      const svgDoc = parser.parseFromString(svgText, "image/svg+xml");
      let svg = svgDoc.documentElement;

      // garante viewBox (para PC e mobile ficarem iguais)
      if(!svg.getAttribute("viewBox")){
        try{
          const bbox = svg.getBBox();
          svg.setAttribute("viewBox", `${bbox.x} ${bbox.y} ${bbox.width} ${bbox.height}`);
        }catch(e){
          // fallback
          svg.setAttribute("viewBox", "0 0 1000 1000");
        }
      }

      svg.setAttribute("preserveAspectRatio", "xMidYMid meet");

      // pega o path principal
      // prioridade: path com id="track" ou class="track", senão o primeiro path
      const path =
        svg.querySelector("#track") ||
        svg.querySelector("path.track") ||
        svg.querySelector("path");

      if(!path) throw new Error("Path não encontrado no SVG");

      const length = path.getTotalLength();
      const samples = 900; // suave e estável
      const points = [];
      for(let i=0;i<=samples;i++){
        const p = path.getPointAtLength((i/samples)*length);
        points.push({ x:p.x, y:p.y });
      }

      return { svg, path, pathPoints: points };
    }

    /***************
     * MAP PROJECTION: SVG coords -> viewport px
     ***************/
    function getViewBox(svg){
      const vb = svg.getAttribute("viewBox") || "0 0 1000 1000";
      const [x,y,w,h] = vb.split(/\s+/).map(Number);
      return { x,y,w,h };
    }

    function projectToViewport(svg, viewportEl, pt){
      const { x, y, w, h } = getViewBox(svg);
      const r = viewportEl.getBoundingClientRect();
      // scale mantendo aspect "meet"
      const scale = Math.min(r.width / w, r.height / h);
      const drawnW = w * scale;
      const drawnH = h * scale;
      const ox = (r.width - drawnW) / 2;
      const oy = (r.height - drawnH) / 2;

      return {
        x: ox + (pt.x - x) * scale,
        y: oy + (pt.y - y) * scale,
        scale
      };
    }

    /***************
     * RACE STATE
     ***************/
    const TIRE_TYPES = [
      { code:"S", label:"S (Soft)", wear: 1.35 },
      { code:"M", label:"M (Medium)", wear: 1.00 },
      { code:"H", label:"H (Hard)", wear: 0.78 },
      { code:"I", label:"I (Inter)", wear: 1.10 },
      { code:"W", label:"W (Wet)", wear: 1.15 }
    ];

    function defaultTireForWeather(){
      if(weather.label === "Chuva") return "W";
      return "M";
    }

    function makeDriverState(d, idx){
      const team = (d.team || "team").toLowerCase();
      return {
        ...d,
        team,
        color: TEAM_COLORS[team] || "#ffffff",
        tire: defaultTireForWeather(),
        tirePct: 100,
        carPct: 100,
        ersPct: 50,
        motorMode: "M2",
        aggress: "A2",
        paceMode: "NORMAL", // NORMAL / ATAQUE / ECONOMIZAR
        pitRequested: false,
        inPit: false,
        pitTimer: 0,
        // progress
        lap: 0,
        progress: 0, // 0..1
        speedBase: 0.00045 + (Math.random() * 0.00020), // estabilidade
        jitter: (Math.random()*0.00002),
        // dom
        dom: {}
      };
    }

    let drivers = GRID.map(makeDriverState);

    // seus pilotos (2 primeiros do userTeam)
    const myDrivers = drivers.filter(d => d.team === userTeam).slice(0,2);
    // se não tiver 2, pega os 2 primeiros do grid
    while(myDrivers.length < 2){
      myDrivers.push(drivers[myDrivers.length]);
    }

    /***************
     * UI RENDER
     ***************/
    function renderSessionList(){
      const list = $("#sessionList");
      list.innerHTML = "";

      drivers
        .slice()
        .sort((a,b)=>{
          // ordem por volta e progresso
          if(b.lap !== a.lap) return b.lap - a.lap;
          return b.progress - a.progress;
        })
        .forEach((d, i) => {
          const row = document.createElement("div");
          row.className = "row";

          const left = document.createElement("div");
          left.className = "row-left";

          const pos = document.createElement("div");
          pos.className = "pos";
          pos.textContent = (i+1);

          const badge = document.createElement("div");
          badge.className = "badge";

          const img = document.createElement("img");
          img.alt = d.name;
          img.src = FACE_PATH(d.id);
          img.onerror = () => {
            // fallback: iniciais
            badge.innerHTML = `<span style="font-weight:950;font-size:11px;color:rgba(255,255,255,.92)">${initials(d.name)}</span>`;
          };
          img.onload = () => {};
          badge.appendChild(img);

          const who = document.createElement("div");
          who.className = "who";
          who.innerHTML = `
            <div class="name">${safeText(d.name)}</div>
            <div class="team">${safeText(d.team).toUpperCase()} • Voltas: ${d.lap} • Pneu: ${d.tire}</div>
          `;

          left.appendChild(pos);
          left.appendChild(badge);
          left.appendChild(who);

          const right = document.createElement("div");
          right.className = "row-right";
          right.innerHTML = `
            <div class="gap">${i===0 ? "LEADER" : "+0.000"}</div>
            <div class="tiny">${d.inPit ? "PIT" : (d.pitRequested ? "PIT (chamado)" : "")}</div>
          `;

          // borda colorida por equipe (leve)
          row.style.boxShadow = `inset 3px 0 0 0 ${d.color}`;

          row.appendChild(left);
          row.appendChild(right);
          list.appendChild(row);
        });
    }

    function renderMyDrivers(){
      const wrap = $("#myDrivers");
      wrap.innerHTML = "";

      myDrivers.forEach((d) => {
        const card = document.createElement("div");
        card.className = "card";

        const faceWrap = document.createElement("div");
        faceWrap.className = "face";

        const img = document.createElement("img");
        img.alt = d.name;
        img.src = FACE_PATH(d.id);
        img.onerror = () => {
          faceWrap.innerHTML = `<div style="width:100%;height:100%;display:grid;place-items:center;font-weight:950;font-size:12px;color:rgba(255,255,255,.92)">${initials(d.name)}</div>`;
        };
        faceWrap.appendChild(img);

        const top = document.createElement("div");
        top.className = "cardTop";
        top.innerHTML = `
          <div class="driverMini">
            <div class="faceHolder"></div>
            <div class="dn">
              <div class="n">${safeText(d.name)}</div>
              <div class="t">${safeText(d.team).toUpperCase()} • ${d.paceMode}</div>
            </div>
          </div>
          <div class="pill">Pneu: <b>${d.tire}</b></div>
        `;
        top.querySelector(".faceHolder").replaceWith(faceWrap);

        const stats = document.createElement("div");
        stats.className = "stats";
        stats.innerHTML = `
          <span>Carro: <b>${Math.round(d.carPct)}%</b></span>
          <span>Pneu: <b>${Math.round(d.tirePct)}%</b></span>
          <span>ERS: <b>${Math.round(d.ersPct)}%</b></span>
          <span>Motor: <b>${d.motorMode}</b></span>
          <span>Agress.: <b>${d.aggress}</b></span>
        `;

        const actions = document.createElement("div");
        actions.className = "actions";

        const pit = document.createElement("div");
        pit.className = "pitBtn " + (d.pitRequested ? "" : "off");
        pit.textContent = "PIT";
        pit.onclick = () => {
          // marca pedido de pit; se já estava pedido, cancela (se ainda não entrou)
          if(d.inPit) return;
          d.pitRequested = !d.pitRequested;
          renderMyDrivers();
          renderSessionList();
        };

        const sel = document.createElement("select");
        sel.className = "sel";
        TIRE_TYPES.forEach(t => {
          const opt = document.createElement("option");
          opt.value = t.code;
          opt.textContent = t.label;
          sel.appendChild(opt);
        });
        sel.value = d.tire;
        sel.onchange = () => {
          // só troca efetivamente quando parar no pit
          d.nextTire = sel.value;
        };

        actions.appendChild(pit);
        actions.appendChild(sel);

        const gridBtns = document.createElement("div");
        gridBtns.className = "gridBtns";

        const eco = document.createElement("div");
        eco.className = "gbtn";
        eco.textContent = "ECONOMIZAR";
        eco.onclick = () => { d.paceMode = "ECONOMIZAR"; renderMyDrivers(); };

        const atk = document.createElement("div");
        atk.className = "gbtn good";
        atk.textContent = "ATAQUE";
        atk.onclick = () => { d.paceMode = "ATAQUE"; renderMyDrivers(); };

        const mMinus = document.createElement("div");
        mMinus.className = "gbtn";
        mMinus.textContent = "MOTOR -";
        mMinus.onclick = () => {
          const order = ["M1","M2","M3"];
          let idx = order.indexOf(d.motorMode);
          if(idx < 0) idx = 1;
          idx = clamp(idx-1,0,order.length-1);
          d.motorMode = order[idx];
          renderMyDrivers();
        };

        const mPlus = document.createElement("div");
        mPlus.className = "gbtn";
        mPlus.textContent = "MOTOR +";
        mPlus.onclick = () => {
          const order = ["M1","M2","M3"];
          let idx = order.indexOf(d.motorMode);
          if(idx < 0) idx = 1;
          idx = clamp(idx+1,0,order.length-1);
          d.motorMode = order[idx];
          renderMyDrivers();
        };

        const aMinus = document.createElement("div");
        aMinus.className = "gbtn";
        aMinus.textContent = "AGRESS -";
        aMinus.onclick = () => {
          const order = ["A1","A2","A3"];
          let idx = order.indexOf(d.aggress);
          if(idx < 0) idx = 1;
          idx = clamp(idx-1,0,order.length-1);
          d.aggress = order[idx];
          renderMyDrivers();
        };

        const aPlus = document.createElement("div");
        aPlus.className = "gbtn";
        aPlus.textContent = "AGRESS +";
        aPlus.onclick = () => {
          const order = ["A1","A2","A3"];
          let idx = order.indexOf(d.aggress);
          if(idx < 0) idx = 1;
          idx = clamp(idx+1,0,order.length-1);
          d.aggress = order[idx];
          renderMyDrivers();
        };

        const ers = document.createElement("div");
        ers.className = "bigbtn";
        ers.textContent = "ERS BOOST";
        ers.onclick = () => {
          d.ersBoostUntil = performance.now() + 3500; // 3.5s
        };

        gridBtns.appendChild(eco);
        gridBtns.appendChild(atk);
        gridBtns.appendChild(mMinus);
        gridBtns.appendChild(mPlus);
        gridBtns.appendChild(aMinus);
        gridBtns.appendChild(aPlus);
        gridBtns.appendChild(ers);

        card.style.boxShadow = `inset 0 0 0 2px rgba(0,0,0,.15), inset 4px 0 0 0 ${d.color}, var(--shadow)`;

        card.appendChild(top);
        card.appendChild(stats);
        card.appendChild(actions);
        card.appendChild(gridBtns);

        wrap.appendChild(card);
      });
    }

    function setMeta(lapNow){
      const clima = weather.label;
      const pista = weather.temp;
      $("#gpMeta").textContent = `Volta ${lapNow} • Clima: ${clima} • Pista: ${pista}°C`;
    }

    /***************
     * CARS / ANIMATION
     ***************/
    let track = null; // { svg, path, pathPoints }
    let dots = new Map(); // driverId -> dotEl
    let sfPlaced = false;

    function ensureDot(d){
      if(dots.has(d.id)) return dots.get(d.id);
      const el = document.createElement("div");
      el.className = "carDot";
      el.style.background = d.color;
      $("#carsLayer").appendChild(el);
      dots.set(d.id, el);
      return el;
    }

    function placeStartFinish(){
      if(!track || sfPlaced) return;
      const sf = $("#sfMarker");
      const p0 = track.pathPoints[0];
      const viewport = $("#trackViewport");
      const pos = projectToViewport(track.svg, viewport, p0);

      // direção inicial para rotação
      const p1 = track.pathPoints[6] || track.pathPoints[1];
      const pos1 = projectToViewport(track.svg, viewport, p1);
      const ang = Math.atan2(pos1.y - pos.y, pos1.x - pos.x) * 180/Math.PI;

      sf.style.left = pos.x + "px";
      sf.style.top = pos.y + "px";
      sf.style.transform = `translate(-50%,-50%) rotate(${ang}deg)`;
      sf.style.display = "block";
      sfPlaced = true;
    }

    function tireWearFactor(d){
      const t = TIRE_TYPES.find(x => x.code === d.tire) || TIRE_TYPES[1];
      let w = t.wear;

      // chuva castiga slick
      if(weather.label === "Chuva" && (d.tire === "S" || d.tire === "M" || d.tire === "H")){
        w *= 1.65;
      }
      // modos
      if(d.paceMode === "ATAQUE") w *= 1.22;
      if(d.paceMode === "ECONOMIZAR") w *= 0.86;

      // agressividade
      if(d.aggress === "A3") w *= 1.10;
      if(d.aggress === "A1") w *= 0.94;

      return w;
    }

    function speedFactor(d, now){
      let f = 1.0;

      // motor
      if(d.motorMode === "M3") f *= 1.10;
      if(d.motorMode === "M1") f *= 0.92;

      // pace
      if(d.paceMode === "ATAQUE") f *= 1.08;
      if(d.paceMode === "ECONOMIZAR") f *= 0.95;

      // desgaste reduz desempenho
      f *= (0.85 + (d.tirePct/100)*0.15);

      // chuva e pneu errado reduz
      if(weather.label === "Chuva" && (d.tire === "S" || d.tire === "M" || d.tire === "H")){
        f *= 0.86;
      }

      // ERS boost
      if(d.ersBoostUntil && now < d.ersBoostUntil && d.ersPct > 5){
        f *= 1.06;
      }
      return f;
    }

    function stepPit(d, dt){
      if(!d.inPit) return;

      d.pitTimer -= dt;
      if(d.pitTimer <= 0){
        d.inPit = false;
        d.pitRequested = false;

        // troca pneu se selecionou
        if(d.nextTire){
          d.tire = d.nextTire;
          d.nextTire = null;
        }
        d.tirePct = 100;

        // pequeno custo de carro/ERS ao longo
        d.ersPct = clamp(d.ersPct + 8, 0, 100);

        renderMyDrivers();
        renderSessionList();
      }
    }

    function maybeEnterPit(d){
      // modelo simples: se pitRequested e passou na linha de chegada (progress cruza 0)
      if(!d.pitRequested || d.inPit) return;
      // vamos entrar no pit no começo da volta: quando progress está bem baixo
      if(d.progress < 0.01){
        d.inPit = true;
        // tempo de pit varia com agress/pneu
        const base = 4.8 + (Math.random()*1.2); // segundos
        const ag = (d.aggress === "A3" ? 0.85 : d.aggress === "A1" ? 1.05 : 0.95);
        d.pitTimer = base * ag;
      }
    }

    let last = performance.now();
    let lapShown = 1;
    let speedMult = 1;

    function update(){
      const now = performance.now();
      const dt = (now - last) / 1000;
      last = now;

      // meta
      setMeta(lapShown);

      // move each driver
      const viewport = $("#trackViewport");

      for(const d of drivers){
        // pit handling
        if(d.inPit){
          stepPit(d, dt);
        }else{
          maybeEnterPit(d);
        }

        // desgaste
        const wear = tireWearFactor(d) * dt * (speedMult * 0.92);
        d.tirePct = clamp(d.tirePct - wear, 0, 100);

        // ERS
        const ersDrain = (d.paceMode === "ATAQUE" ? 5.2 : 3.2) * dt * (speedMult);
        const ersCharge = (d.paceMode === "ECONOMIZAR" ? 2.4 : 1.1) * dt;
        if(d.ersBoostUntil && now < d.ersBoostUntil){
          d.ersPct = clamp(d.ersPct - ersDrain, 0, 100);
        }else{
          d.ersPct = clamp(d.ersPct + ersCharge, 0, 100);
        }

        // velocidade (se estiver no pit, anda mais lento)
        const base = d.speedBase;
        let speed = base * speedFactor(d, now) * speedMult;
        if(d.inPit) speed *= 0.20;

        // avança
        const prev = d.progress;
        d.progress += speed + d.jitter;

        if(d.progress >= 1){
          d.progress -= 1;
          d.lap += 1;
        }

        // lap global estimado pelo líder (para HUD)
        // (apenas leitura; não afeta sim)
      }

      // render cars positions
      if(track){
        const pts = track.pathPoints;
        const n = pts.length;
        for(const d of drivers){
          const idx = Math.floor(clamp(d.progress,0,0.999999) * (n-1));
          const pt = pts[idx];

          const p = projectToViewport(track.svg, viewport, pt);

          // cria dot
          const dot = ensureDot(d);
          dot.style.left = p.x + "px";
          dot.style.top = p.y + "px";
          dot.style.background = d.color;
        }
      }

      // atualiza leaderboard (sem piscar rosto: só atualiza texto/ordem)
      // (ordenação leve – não re-render a cada frame; a cada ~300ms)
      if(!update._acc) update._acc = 0;
      update._acc += dt;
      if(update._acc > 0.30){
        update._acc = 0;

        // atualiza lapShown pelo líder
        const leader = drivers.slice().sort((a,b)=>{
          if(b.lap !== a.lap) return b.lap - a.lap;
          return b.progress - a.progress;
        })[0];
        lapShown = clamp(leader.lap + 1, 1, totalLaps);

        renderSessionList();
        renderMyDrivers();
      }

      requestAnimationFrame(update);
    }

    /***************
     * SPEED UI
     ***************/
    $$(".chip[data-speed]").forEach(ch => {
      ch.onclick = () => {
        $$(".chip[data-speed]").forEach(x => x.classList.remove("active"));
        ch.classList.add("active");
        speedMult = parseInt(ch.dataset.speed, 10) || 1;
      };
    });

    /***************
     * BOOT
     ***************/
    (async function boot(){
      try{
        // header meta
        setMeta(1);

        // load track
        track = await loadTrackSVG(trackName);

        // inject svg
        const vp = $("#trackViewport");
        // limpa svg anterior
        $$("svg", vp).forEach(s => s.remove());
        vp.prepend(track.svg);

        // garante cars layer por cima
        $("#carsLayer").style.zIndex = "5";
        track.svg.style.zIndex = "1";

        // coloca marcador S/F
        sfPlaced = false;
        placeStartFinish();

        // render UI
        renderSessionList();
        renderMyDrivers();

        // iniciar
        requestAnimationFrame(()=> {
          last = performance.now();
          update();
        });

      }catch(err){
        alert("Erro na corrida: " + (err && err.message ? err.message : err));
      }
    })();
  </script>
</body>
</html>
