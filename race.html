<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>F1 MANAGER 2025 — CORRIDA</title>
  <style>
    :root{
      --bg1:#070b14; --bg2:#0c1430;
      --panel:rgba(18,24,40,.72);
      --panel2:rgba(18,24,40,.45);
      --shadow:0 12px 30px rgba(0,0,0,.45);
      --radius:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:radial-gradient(1200px 700px at 15% 0%, #1a244a 0%, var(--bg1) 45%, #04060d 100%); color:#fff; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    body{overflow:hidden}
    .topbar{
      position:fixed; inset:0 0 auto 0; height:76px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:12px 14px;
      background:linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,.10));
      backdrop-filter: blur(10px);
      z-index:20;
    }
    .gpbox{
      display:flex; align-items:center; gap:10px;
      padding:10px 12px;
      border-radius:16px;
      background:rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.08);
      box-shadow: var(--shadow);
      min-width:280px;
    }
    .gpbox img{width:28px;height:28px;object-fit:contain; border-radius:8px; background:rgba(255,255,255,.06)}
    .gpbox .t1{font-weight:900; letter-spacing:.2px; font-size:14px; line-height:1.05}
    .gpbox .t2{opacity:.85; font-size:12px; margin-top:2px}
    .controls{display:flex; align-items:center; gap:10px;}
    .pill{
      display:flex; gap:8px; align-items:center;
      padding:10px 12px;
      border-radius:999px;
      background:rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.08);
      box-shadow: var(--shadow);
    }
    .btnSpeed{
      width:44px; height:34px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      color:#fff; font-weight:900;
      cursor:pointer;
    }
    .btnSpeed.active{background:rgba(195,35,70,.55); border-color:rgba(255,120,150,.35);}
    .btnLobby{
      height:42px; padding:0 16px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.10);
      color:#fff; font-weight:950;
      cursor:pointer;
    }

    .layout{
      position:absolute; inset:76px 0 0 0;
      display:grid;
      grid-template-columns: minmax(320px, 1.05fr) minmax(340px, .95fr);
      gap:14px;
      padding:14px;
      overflow:hidden;
    }
    .card{
      border-radius:var(--radius);
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(0,0,0,.28));
      border:1px solid rgba(255,255,255,.08);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardHeader{
      padding:12px 14px;
      display:flex; align-items:center; justify-content:space-between;
      background:rgba(0,0,0,.22);
      border-bottom:1px solid rgba(255,255,255,.06);
      font-weight:950;
      letter-spacing:.35px;
      text-transform:uppercase;
      font-size:13px;
    }
    .cardHeader .meta{opacity:.75; font-weight:800; text-transform:none; letter-spacing:0; font-size:12px}

    .trackWrap{height:100%;display:flex;flex-direction:column;}
    .trackBody{position:relative;flex:1;padding:10px;}
    .trackCanvas{
      position:absolute; inset:10px;
      width:calc(100% - 20px);
      height:calc(100% - 20px);
      border-radius:16px;
      background:#000;
      border:1px solid rgba(255,255,255,.08);
    }

    .rightCol{display:flex; flex-direction:column; gap:14px; height:100%; overflow:hidden;}
    .sessionList{height:100%; overflow:auto; padding:10px; scrollbar-width:thin;}

    .row{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      padding:10px 10px;
      border-radius:14px;
      background:rgba(0,0,0,.24);
      border:1px solid rgba(255,255,255,.06);
      margin-bottom:10px;
    }
    .rowLeft{display:flex; align-items:center; gap:10px; min-width:0}
    .pos{
      width:34px; height:34px; border-radius:12px;
      display:grid; place-items:center;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.05);
      font-weight:950;
    }
    .face, .dFace{
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      object-fit:cover;
      flex:0 0 auto;
    }
    .face{width:34px;height:34px;border-radius:12px;}
    .nameBlock{min-width:0}
    .nm{font-weight:950; font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .tm{opacity:.75; font-size:11px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .delta{font-weight:950; font-size:12px; opacity:.9}
    .leader{opacity:.9; font-weight:950; font-size:12px}

    .driversCard{padding:10px;}
    .driversGrid{display:grid; grid-template-columns:1fr 1fr; gap:10px;}
    .dCard{
      border-radius:16px;
      background:rgba(0,0,0,.24);
      border:1px solid rgba(255,255,255,.06);
      padding:10px;
      min-height:168px;
      position:relative;
      overflow:hidden;
    }
    .dTop{display:flex; align-items:center; gap:10px; margin-bottom:8px;}
    .dFace{width:40px;height:40px;border-radius:14px;}
    .dTitle{min-width:0}
    .dName{font-weight:950; font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .dTeam{opacity:.75; font-size:11px}
    .chips{display:flex; flex-wrap:wrap; gap:6px; margin:8px 0}
    .chip{
      padding:6px 8px; border-radius:999px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.08);
      font-size:11px; font-weight:900;
    }
    .hint{
      position:absolute; right:10px; top:10px;
      width:10px; height:10px; border-radius:999px;
      opacity:.95;
      box-shadow: 0 0 0 3px rgba(255,255,255,.08);
    }

    .badgeLap{
      margin-left:10px;
      padding:6px 10px;
      border-radius:999px;
      font-weight:950;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.08);
      font-size:12px;
    }

    @media (max-width: 980px){
      body{overflow:auto}
      .layout{
        position:relative; inset:auto;
        grid-template-columns: 1fr;
        padding-top:90px;
      }
      .trackWrap{min-height:420px}
      .rightCol{height:auto}
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="gpbox">
      <img id="gpLogo" alt="GP" />
      <div>
        <div class="t1" id="gpTitle">GP</div>
        <div class="t2" id="gpMeta">Volta 1 • Clima: — • Pista: —°C</div>
      </div>
      <div class="badgeLap" id="lapBadge">VOLTA 1</div>
    </div>

    <div class="controls">
      <div class="pill" aria-label="Velocidade">
        <button class="btnSpeed active" data-speed="1">1x</button>
        <button class="btnSpeed" data-speed="2">2x</button>
        <button class="btnSpeed" data-speed="4">4x</button>
      </div>
      <button class="btnLobby" id="btnLobby">VOLTAR AO LOBBY</button>
    </div>
  </div>

  <div class="layout">
    <div class="card trackWrap">
      <div class="cardHeader">
        <div>MAPA DA PISTA</div>
        <div class="meta" id="trackMeta">SVG • pathPoints • 60fps</div>
      </div>
      <div class="trackBody">
        <canvas id="trackCanvas" class="trackCanvas"></canvas>
      </div>
    </div>

    <div class="rightCol">
      <div class="card" style="flex:1; min-height:260px;">
        <div class="cardHeader">
          <div>SESSÃO</div>
          <div class="meta">Tempo real</div>
        </div>
        <div class="sessionList" id="sessionList"></div>
      </div>

      <div class="card driversCard">
        <div class="cardHeader">
          <div>SEUS PILOTOS</div>
          <div class="meta">Controles</div>
        </div>
        <div class="driversGrid" id="myDrivers"></div>
      </div>
    </div>
  </div>

<script>
(function(){
  const qs = new URLSearchParams(location.search);
  const TRACK = (qs.get("track") || "australia").toLowerCase().trim();
  const GP = (qs.get("gp") || "GP da Austrália 2025");
  const USER_TEAM = (qs.get("userTeam") || "mclaren").toLowerCase().trim();

  const TOTAL_LAPS = 5; // ajuste se quiser
  let CURRENT_LAP = 1;

  const $ = (id)=>document.getElementById(id);

  function setLapUI(){
    $("lapBadge").textContent = `VOLTA ${CURRENT_LAP}`;
    // também no texto do header:
    const meta = $("gpMeta").textContent;
    const parts = meta.split("•").map(s=>s.trim());
    // força "Volta X" no começo:
    if(parts.length){
      parts[0] = `Volta ${CURRENT_LAP}/${TOTAL_LAPS}`;
      $("gpMeta").textContent = parts.join(" • ");
    }
  }

  function slugify(s){
    return (s||"")
      .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
      .toLowerCase()
      .replace(/[^a-z0-9]+/g,"_")
      .replace(/^_+|_+$/g,"");
  }

  function initials(name){
    const p = (name||"").trim().split(/\s+/).filter(Boolean);
    const a = (p[0]||"")[0]||"?";
    const b = (p[p.length-1]||"")[0]||"";
    return (a+b).toUpperCase();
  }

  const TEAM_COLOR = {
    ferrari: "#dc0000",
    mclaren: "#ff8000",
    mercedes: "#00d2be",
    redbull: "#1e41ff",
    rb: "#6c7fff",
    williams: "#00a3e0",
    alpine: "#ff87bc",
    astonmartin: "#006f62",
    haas: "#b6babd",
    sauber: "#00ff87",
    audi: "#00ff87",
    free_agent: "#9aa3b2"
  };
  function teamKey(team){
    return (team||"").toLowerCase().replace(/[^a-z0-9]/g,"");
  }
  function teamColor(team){
    return TEAM_COLOR[teamKey(team)] || "#9aa3b2";
  }

  // Header
  $("gpTitle").textContent = GP;
  $("gpMeta").textContent = `Volta 1/${TOTAL_LAPS} • Clima: Chuva • Pista: 21°C`;
  $("gpLogo").src = "assets/flags/australia.png";
  $("gpLogo").onerror = ()=>{ $("gpLogo").style.display="none"; };
  setLapUI();

  // Speed
  let SPEED = 1;
  document.querySelectorAll(".btnSpeed").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      document.querySelectorAll(".btnSpeed").forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      SPEED = parseInt(btn.dataset.speed,10) || 1;
    });
  });

  $("btnLobby").addEventListener("click", ()=>{ location.href = "index.html"; });

  // Canvas
  const canvas = $("trackCanvas");
  const ctx = canvas.getContext("2d", { alpha:false });
  function resizeCanvas(){
    const rect = canvas.getBoundingClientRect();
    const dpr = Math.max(1, Math.min(3, window.devicePixelRatio || 1));
    canvas.width = Math.floor(rect.width * dpr);
    canvas.height = Math.floor(rect.height * dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);
  }
  window.addEventListener("resize", resizeCanvas, { passive:true });

  async function tryLoadImage(url){
    return new Promise((resolve)=>{
      const img = new Image();
      img.decoding = "async";
      img.loading = "eager";
      img.src = url;
      img.onload = ()=>resolve(url);
      img.onerror = ()=>resolve(null);
    });
  }

  // Loader de face mais inteligente: tenta múltiplos padrões
  async function loadFaceUrl(driverName){
    const name = (driverName||"").trim();
    const parts = name.split(/\s+/).filter(Boolean);
    const first = parts[0] ? slugify(parts[0]) : "";
    const last  = parts.length>1 ? slugify(parts[parts.length-1]) : "";
    const full  = slugify(name);

    // aliases comuns (se você tiver arquivos assim)
    const ALIASES = {
      "max_verstappen": ["verstappen","max"],
      "sergio_perez": ["perez","checo_perez","checo"],
      "lewis_hamilton": ["hamilton","lewis"],
      "charles_leclerc": ["leclerc","charles"],
      "carlos_sainz": ["sainz","carlos"],
      "lando_norris": ["norris","lando"],
      "oscar_piastri": ["piastri","oscar"],
      "fernando_alonso": ["alonso","fernando"],
      "george_russell": ["russell","george"],
      "yuki_tsunoda": ["tsunoda","yuki"],
      "nico_hulkenberg": ["hulkenberg","nico"]
    };

    const candidates = [];
    candidates.push(full);
    if(first) candidates.push(first);
    if(last) candidates.push(last);
    if(first && last) candidates.push(first + "_" + last);

    const alias = ALIASES[full];
    if(alias) alias.forEach(a=>candidates.push(slugify(a)));

    const exts = [".png",".webp",".jpg",".jpeg"];
    const bases = candidates
      .map(c=>c.replace(/^_+|_+$/g,""))
      .filter(Boolean)
      .filter((v,i,a)=>a.indexOf(v)===i);

    for(const b of bases){
      for(const e of exts){
        const url = `assets/faces/${b}${e}`;
        const ok = await tryLoadImage(url);
        if(ok) return ok;
      }
    }
    return null;
  }

  function makeInitialAvatar(text){
    const el = document.createElement("div");
    el.style.width="34px";
    el.style.height="34px";
    el.style.borderRadius="12px";
    el.style.display="grid";
    el.style.placeItems="center";
    el.style.fontWeight="950";
    el.style.fontSize="12px";
    el.style.background="rgba(255,255,255,.06)";
    el.style.border="1px solid rgba(255,255,255,.10)";
    el.textContent = text;
    return el;
  }

  function makeInitialAvatarBig(text){
    const el = document.createElement("div");
    el.style.width="40px";
    el.style.height="40px";
    el.style.borderRadius="14px";
    el.style.display="grid";
    el.style.placeItems="center";
    el.style.fontWeight="950";
    el.style.fontSize="12px";
    el.style.background="rgba(255,255,255,.06)";
    el.style.border="1px solid rgba(255,255,255,.10)";
    el.textContent = text;
    return el;
  }

  // SVG
  async function fetchText(url){
    const r = await fetch(url, { cache:"no-store" });
    if(!r.ok) throw new Error(`${r.status} ${r.statusText}`);
    return await r.text();
  }
  function parseFirstPathD(svgText){
    const doc = new DOMParser().parseFromString(svgText, "image/svg+xml");
    const path = doc.querySelector("path");
    if(path && path.getAttribute("d")) return path.getAttribute("d");
    const poly = doc.querySelector("polyline,polygon");
    if(poly && poly.getAttribute("points")) return { points: poly.getAttribute("points") };
    throw new Error("SVG sem <path d> nem points.");
  }
  function samplePathPointsFromD(d, samples=950){
    const svg = document.createElementNS("http://www.w3.org/2000/svg","svg");
    svg.setAttribute("width","1000"); svg.setAttribute("height","1000");
    const path = document.createElementNS("http://www.w3.org/2000/svg","path");
    path.setAttribute("d", d);
    svg.appendChild(path);
    document.body.appendChild(svg);
    svg.style.position="absolute"; svg.style.left="-99999px"; svg.style.top="-99999px";
    const len = path.getTotalLength();
    const pts = [];
    for(let i=0;i<samples;i++){
      const p = path.getPointAtLength((i/(samples))*len);
      pts.push({x:p.x, y:p.y});
    }
    document.body.removeChild(svg);
    return pts;
  }
  function parsePointsString(pointsStr){
    const pts = [];
    pointsStr.trim().split(/\s+/).forEach(pair=>{
      const [x,y] = pair.split(",").map(Number);
      if(Number.isFinite(x) && Number.isFinite(y)) pts.push({x,y});
    });
    return pts;
  }
  function computeFit(pts, pad=30){
    let minX=Infinity,minY=Infinity,maxX=-Infinity,maxY=-Infinity;
    for(const p of pts){
      minX=Math.min(minX,p.x); minY=Math.min(minY,p.y);
      maxX=Math.max(maxX,p.x); maxY=Math.max(maxY,p.y);
    }
    const w = maxX-minX, h=maxY-minY;
    const rect = canvas.getBoundingClientRect();
    const cw = rect.width, ch = rect.height;
    const sx = (cw - pad*2) / (w || 1);
    const sy = (ch - pad*2) / (h || 1);
    const s = Math.min(sx, sy);
    const ox = (cw - w*s)/2 - minX*s;
    const oy = (ch - h*s)/2 - minY*s;
    return { s, ox, oy };
  }

  // Grid (troque pelo seu grid real quando quiser)
  const GRID = [
    {name:"Lando Norris", team:"mclaren"},
    {name:"Oscar Piastri", team:"mclaren"},
    {name:"Charles Leclerc", team:"ferrari"},
    {name:"Carlos Sainz", team:"ferrari"},
    {name:"Lewis Hamilton", team:"mercedes"},
    {name:"George Russell", team:"mercedes"},
    {name:"Max Verstappen", team:"redbull"},
    {name:"Sergio Perez", team:"redbull"},
    {name:"Fernando Alonso", team:"astonmartin"},
    {name:"Lance Stroll", team:"astonmartin"},
    {name:"Pierre Gasly", team:"alpine"},
    {name:"Esteban Ocon", team:"alpine"},
    {name:"Alex Albon", team:"williams"},
    {name:"Logan Sargeant", team:"williams"},
    {name:"Yuki Tsunoda", team:"rb"},
    {name:"Liam Lawson", team:"rb"},
    {name:"Nico Hulkenberg", team:"haas"},
    {name:"Kevin Magnussen", team:"haas"},
    {name:"Guanyu Zhou", team:"sauber"},
    {name:"Gabriel Bortoleto", team:"sauber"}
  ];

  const MY = GRID.filter(d => d.team === USER_TEAM).slice(0,2);
  while(MY.length < 2) MY.push({name:"Piloto "+(MY.length+1), team:USER_TEAM});

  async function renderSessionList(){
    const list = $("sessionList");
    list.innerHTML = "";
    for(let i=0;i<GRID.length;i++){
      const d = GRID[i];
      const row = document.createElement("div");
      row.className = "row";
      row.style.borderLeft = `4px solid ${teamColor(d.team)}`;

      const left = document.createElement("div");
      left.className = "rowLeft";

      const pos = document.createElement("div");
      pos.className = "pos";
      pos.textContent = (i+1);

      const avatarWrap = document.createElement("div");

      const faceUrl = await loadFaceUrl(d.name);
      if(faceUrl){
        const img = document.createElement("img");
        img.className = "face";
        img.alt = d.name;
        img.src = faceUrl;
        avatarWrap.appendChild(img);
      }else{
        avatarWrap.appendChild(makeInitialAvatar(initials(d.name)));
      }

      const nameBlock = document.createElement("div");
      nameBlock.className = "nameBlock";
      const nm = document.createElement("div");
      nm.className = "nm";
      nm.textContent = d.name;
      const tm = document.createElement("div");
      tm.className = "tm";
      tm.textContent = (d.team || "").toUpperCase() + ` • Voltas: ${CURRENT_LAP-1} • Pneu: W`;
      nameBlock.appendChild(nm); nameBlock.appendChild(tm);

      left.appendChild(pos);
      left.appendChild(avatarWrap);
      left.appendChild(nameBlock);

      const right = document.createElement("div");
      right.innerHTML = (i===0) ? `<div class="leader">LEADER</div>` : `<div class="delta">+0.000</div>`;

      row.appendChild(left);
      row.appendChild(right);
      list.appendChild(row);
    }
  }

  async function renderMyDrivers(){
    const box = $("myDrivers");
    box.innerHTML = "";
    for(const d of MY){
      const card = document.createElement("div");
      card.className = "dCard";

      const dot = document.createElement("div");
      dot.className = "hint";
      dot.style.background = teamColor(d.team);

      const top = document.createElement("div");
      top.className = "dTop";

      const faceUrl = await loadFaceUrl(d.name);
      if(faceUrl){
        const img = document.createElement("img");
        img.className = "dFace";
        img.alt = d.name;
        img.src = faceUrl;
        top.appendChild(img);
      }else{
        top.appendChild(makeInitialAvatarBig(initials(d.name)));
      }

      const title = document.createElement("div");
      title.className = "dTitle";

      const dn = document.createElement("div");
      dn.className = "dName";
      dn.textContent = d.name;

      const dt = document.createElement("div");
      dt.className = "dTeam";
      dt.textContent = (d.team||"").toUpperCase() + " • NORMAL";

      title.appendChild(dn); title.appendChild(dt);
      top.appendChild(title);

      const chips = document.createElement("div");
      chips.className = "chips";
      chips.innerHTML = `
        <div class="chip">Carro: 100%</div>
        <div class="chip">Pneu: 79%</div>
        <div class="chip">ERS: 72%</div>
        <div class="chip">Motor: M2</div>
        <div class="chip">Agress.: A2</div>
      `;

      card.appendChild(dot);
      card.appendChild(top);
      card.appendChild(chips);
      box.appendChild(card);
    }
  }

  // Race points
  let TRACK_POINTS = [];
  let FIT = {s:1,ox:0,oy:0};

  function toCanvas(p){
    return { x: p.x*FIT.s + FIT.ox, y: p.y*FIT.s + FIT.oy };
  }

  // Para contar volta: detecta cruzamento da linha de chegada (entre ponto 0 e ponto 1)
  // Considera “cruzou” quando t sai de >0.98 para <0.02 (wrap-around).
  const cars = GRID.map((d, idx)=>({
    driver:d.name,
    team:d.team,
    t: (idx / GRID.length) * 0.85,
    v: 0.00055 + (idx%7)*0.00002,
    lastT: 0
  }));

  function drawTrack(){
    const rect = canvas.getBoundingClientRect();
    const w = rect.width, h = rect.height;
    ctx.fillStyle = "#000";
    ctx.fillRect(0,0,w,h);

    if(TRACK_POINTS.length < 3) return;

    ctx.lineJoin = "round";
    ctx.lineCap = "round";

    // base
    ctx.beginPath();
    for(let i=0;i<TRACK_POINTS.length;i++){
      const p = toCanvas(TRACK_POINTS[i]);
      if(i===0) ctx.moveTo(p.x,p.y); else ctx.lineTo(p.x,p.y);
    }
    ctx.closePath();
    ctx.strokeStyle = "rgba(255,255,255,.18)";
    ctx.lineWidth = 18;
    ctx.stroke();

    // mid
    ctx.beginPath();
    for(let i=0;i<TRACK_POINTS.length;i++){
      const p = toCanvas(TRACK_POINTS[i]);
      if(i===0) ctx.moveTo(p.x,p.y); else ctx.lineTo(p.x,p.y);
    }
    ctx.closePath();
    ctx.strokeStyle = "rgba(200,210,230,.42)";
    ctx.lineWidth = 12;
    ctx.stroke();

    // white
    ctx.beginPath();
    for(let i=0;i<TRACK_POINTS.length;i++){
      const p = toCanvas(TRACK_POINTS[i]);
      if(i===0) ctx.moveTo(p.x,p.y); else ctx.lineTo(p.x,p.y);
    }
    ctx.closePath();
    ctx.strokeStyle = "rgba(255,255,255,.92)";
    ctx.lineWidth = 6;
    ctx.stroke();

    // linha de chegada (pequena “faixa” transversal)
    const p0 = toCanvas(TRACK_POINTS[0]);
    const p1 = toCanvas(TRACK_POINTS[6] || TRACK_POINTS[1]);
    const dx = p1.x - p0.x, dy = p1.y - p0.y;
    const len = Math.hypot(dx,dy) || 1;
    const nx = -dy/len, ny = dx/len; // normal
    const a = { x: p0.x + nx*10, y: p0.y + ny*10 };
    const b = { x: p0.x - nx*10, y: p0.y - ny*10 };
    ctx.beginPath();
    ctx.moveTo(a.x,a.y); ctx.lineTo(b.x,b.y);
    ctx.strokeStyle = "rgba(255,255,255,.95)";
    ctx.lineWidth = 3;
    ctx.stroke();
  }

  // Atualiza volta baseado no líder (car 0 na ordem do GRID)
  function updateLapFromLeader(){
    const leader = cars[0];
    if(leader.lastT > 0.98 && leader.t < 0.02){
      if(CURRENT_LAP < TOTAL_LAPS){
        CURRENT_LAP++;
        setLapUI();
        // Atualiza texto na lista (sem “travado em 1”)
        renderSessionList();
      }
    }
  }

  function drawCars(){
    if(TRACK_POINTS.length < 3) return;

    for(const c of cars){
      c.lastT = c.t;
      c.t = (c.t + c.v * SPEED) % 1;

      const idx = Math.floor(c.t * TRACK_POINTS.length);
      const p0 = TRACK_POINTS[idx % TRACK_POINTS.length];
      const a = toCanvas(p0);

      ctx.beginPath();
      ctx.fillStyle = teamColor(c.team);
      ctx.arc(a.x, a.y, 5, 0, Math.PI*2);
      ctx.fill();

      ctx.beginPath();
      ctx.fillStyle = "rgba(255,255,255,.25)";
      ctx.arc(a.x-2, a.y-2, 2.2, 0, Math.PI*2);
      ctx.fill();
    }

    updateLapFromLeader();
  }

  function loop(){
    drawTrack();
    drawCars();
    requestAnimationFrame(loop);
  }

  async function boot(){
    resizeCanvas();

    // você só tem SVG em assets/tracks/
    const svgUrl = `assets/tracks/${TRACK}.svg`;

    try{
      const svgText = await fetchText(svgUrl);
      const dOrPoints = parseFirstPathD(svgText);
      if(typeof dOrPoints === "string"){
        TRACK_POINTS = samplePathPointsFromD(dOrPoints, 980);
      }else{
        TRACK_POINTS = parsePointsString(dOrPoints.points);
      }
      FIT = computeFit(TRACK_POINTS, 30);

      await renderSessionList();
      await renderMyDrivers();

      loop();
    }catch(err){
      alert("Erro na corrida: Falha ao carregar: " + svgUrl + "\n\nDetalhe: " + err.message);
      console.error(err);
    }
  }

  boot();
})();
</script>
</body>
</html>
